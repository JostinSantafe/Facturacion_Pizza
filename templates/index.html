<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>M√≥dulo de Facturaci√≥n - Pizzer√≠a</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>

<body>

<header>
    <h1>M√≥dulo de Facturaci√≥n</h1>
</header>

<!-- PANTALLA 1: Selecci√≥n de Productos -->
<section id="pantalla-productos" class="pantalla activa">
    <div class="container">
        <h2>Selecciona tus productos</h2>
        
        <section class="productos-container">
            {% for p in productos %}
            <div class="card">
                <img src="{{ url_for('static', filename='imagenes/' + p.img) }}" alt="{{ p.nombre }}">
                <h3>{{ p.nombre }}</h3>
                <p class="precio">${{ "{:,.0f}".format(p.precio) }}</p>
                <button onclick="agregarAlCarrito('{{ p.nombre }}', {{ p.precio }})">Agregar al Carrito</button>
            </div>
            {% endfor %}
        </section>

        <section id="carrito-section" class="carrito-fijo">
            <div id="carrito">
                <h2>Carrito de Compras</h2>
                <ul id="lista-carrito"></ul>
                <p id="carrito-vacio">Tu carrito est√° vac√≠o.</p>

                <div id="carrito-totales" style="display:none;">
                    <hr>
                    <p><strong>Subtotal: $<span id="subtotal">0</span></strong></p>
                    <p><strong>IVA (19%): $<span id="iva">0</span></strong></p>
                    <p class="total"><strong>Total: $<span id="total">0</span></strong></p>
                </div>

                <div id="carrito-botones" style="display:none;">
                    <button id="pagarBtn" class="btn-pagar" onclick="irAlFormulario()">Proceder al Pago</button>
                    <button id="vaciarBtn" class="btn-vaciar" onclick="vaciarCarrito()">Vaciar Carrito</button>
                </div>
            </div>
        </section>
    </div>
</section>

<!-- PANTALLA 2: Datos del Cliente -->
<section id="pantalla-cliente" class="pantalla">
    <div class="container modal-overlay">
        <div class="modal">
            <h2>Datos del Cliente</h2>
            
            <form id="formulario-cliente" onsubmit="generarFactura(event)">
                <div class="form-group">
                    <label for="nombre">Nombre completo *</label>
                    <input type="text" id="nombre" name="nombre" required placeholder="Ej: Juan P√©rez">
                </div>

                <div class="form-group">
                    <label for="nit">NIT del receptor *</label>
                    <input type="text" id="nit" name="nit" required placeholder="Ej: 1234567890">
                </div>

                <div class="form-group">
                    <label for="email">Correo electr√≥nico *</label>
                    <input type="email" id="email" name="email" required placeholder="Ej: cliente@example.com">
                </div>

                <div class="form-buttons">
                    <button type="button" class="btn-cancelar" onclick="volverAlCarrito()">Cancelar</button>
                    <button type="submit" class="btn-continuar">Continuar</button>
                </div>
            </form>
        </div>
    </div>
</section>

<!-- PANTALLA 3: Confirmaci√≥n y Descarga -->
<section id="pantalla-confirmacion" class="pantalla">
    <div class="container modal-overlay">
        <div class="modal success-modal">
            <h2>Factura generada correctamente</h2>
            
            <div class="confirmacion-info">
                <p><strong>ID de Factura:</strong> <span id="factura-id">-</span></p>
                <p><strong>Cliente:</strong> <span id="factura-nombre">-</span></p>
                <p><strong>Total:</strong> $<span id="factura-total">0</span></p>
            </div>

            <div class="confirmacion-botones">
                <button class="btn-descargar" onclick="descargarPDF()">
                    <span>üìÑ</span> Descargar Tirilla PDF
                </button>
                <button class="btn-nuevo-pedido" onclick="nuevoProducto()">
                    <span>‚ûï</span> Continuar con otro pedido
                </button>
            </div>
        </div>
    </div>
</section>

<!-- PANTALLA 4: Cargando -->
<section id="pantalla-cargando" class="pantalla">
    <div class="container modal-overlay">
        <div class="modal loading-modal">
            <div class="spinner"></div>
            <p>Generando factura...</p>
        </div>
    </div>
</section>

<script>
let carrito = [];
let facturaActual = null;

// ==================== FUNCIONES DE CARRITO ====================

function agregarAlCarrito(nombre, precio) {
    let item = carrito.find(p => p.nombre === nombre);

    if (item) {
        item.cantidad++;
    } else {
        carrito.push({ nombre, precio, cantidad: 1 });
    }
    mostrarCarrito();
}

function eliminarProducto(index) {
    carrito.splice(index, 1);
    mostrarCarrito();
}

function vaciarCarrito() {
    if (confirm("¬øVaciar carrito?")) {
        carrito = [];
        mostrarCarrito();
    }
}

function mostrarCarrito() {
    let lista = document.getElementById("lista-carrito");
    let carritoVacio = document.getElementById("carrito-vacio");
    let totales = document.getElementById("carrito-totales");
    let botones = document.getElementById("carrito-botones");
    let total = 0;
    let subtotal = 0;

    lista.innerHTML = "";

    if (carrito.length === 0) {
        carritoVacio.style.display = "block";
        totales.style.display = "none";
        botones.style.display = "none";
        return;
    }

    carritoVacio.style.display = "none";
    totales.style.display = "block";
    botones.style.display = "flex";

    carrito.forEach((p, i) => {
        let importe = p.precio * p.cantidad;
        subtotal += importe;
        
        let li = document.createElement("li");
        li.innerHTML = `
            <div class="item-carrito">
                <span>${p.nombre}</span>
                <span>x${p.cantidad}</span>
                <span>$${importe.toLocaleString()}</span>
                <button class="btn-eliminar" onclick="eliminarProducto(${i})">‚úï</button>
            </div>
        `;
        lista.appendChild(li);
    });

    let iva = Math.round(subtotal * 0.19);
    total = subtotal + iva;

    document.getElementById("subtotal").innerText = subtotal.toLocaleString();
    document.getElementById("iva").innerText = iva.toLocaleString();
    document.getElementById("total").innerText = total.toLocaleString();
}

// ==================== FUNCIONES DE NAVEGACI√ìN ====================

function irAlFormulario() {
    if (carrito.length === 0) {
        alert("El carrito est√° vac√≠o.");
        return;
    }
    mostrarPantalla("pantalla-cliente");
    document.getElementById("formulario-cliente").reset();
}

function volverAlCarrito() {
    mostrarPantalla("pantalla-productos");
}

function mostrarPantalla(id) {
    // Ocultar todas las pantallas
    document.querySelectorAll(".pantalla").forEach(p => {
        p.classList.remove("activa");
    });
    
    // Mostrar la pantalla especificada
    document.getElementById(id).classList.add("activa");
}

// ==================== FUNCIONES DE FACTURA ====================

function generarFactura(event) {
    event.preventDefault();
    
    const nombre = document.getElementById("nombre").value;
    const nit = document.getElementById("nit").value;
    const email = document.getElementById("email").value;
    
    mostrarPantalla("pantalla-cargando");
    
    let subtotal = carrito.reduce((sum, item) => sum + (item.precio * item.cantidad), 0);
    let iva = Math.round(subtotal * 0.19);
    let total = subtotal + iva;
    
    fetch("/pagar", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
            cliente: { nombre, nit, email },
            carrito: carrito
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === "success") {
            facturaActual = {
                id: data.factura_id,
                nombre: nombre,
                total: total
            };
            
            // Mostrar confirmaci√≥n
            document.getElementById("factura-id").innerText = data.factura_id;
            document.getElementById("factura-nombre").innerText = nombre;
            document.getElementById("factura-total").innerText = total.toLocaleString();
            
            mostrarPantalla("pantalla-confirmacion");
        } else {
            alert("Error: " + data.message);
            mostrarPantalla("pantalla-cliente");
        }
    })
    .catch(error => {
        console.error("Error:", error);
        alert("Error al generar factura: " + error.message);
        mostrarPantalla("pantalla-cliente");
    });
}

function descargarPDF() {
    if (facturaActual) {
        // Crear un enlace de descarga temporal
        const link = document.createElement('a');
        link.href = `/descargar-pdf/${facturaActual.id}`;
        link.download = `${facturaActual.id}.pdf`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
}

function nuevoProducto() {
    carrito = [];
    mostrarCarrito();
    mostrarPantalla("pantalla-productos");
    window.scrollTo(0, 0);
}

// Inicializar
mostrarCarrito();
</script>

</body>
</html>
